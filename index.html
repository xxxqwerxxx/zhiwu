<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>æ¤ç‰©æ‹–æ‹½èŠ±ç›†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        background: #f8fff8;
      }
      .container {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .plant-selector {
        height: 15vh;
        min-height: 90px;
        background: #e0ffe0;
        overflow-x: auto;
        display: flex;
        align-items: center;
        padding: 10px;
        box-sizing: border-box;
      }
      .plant-item {
        margin-right: 20px;
        text-align: center;
        user-select: none;
      }
      .plant-item img {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border-radius: 8px;
        cursor: grab;
        background: #fff;
        box-shadow: 0 2px 6px #0001;
        display: block;
        margin: 0 auto;
      }
      .plant-item .name {
        font-size: 14px;
        margin-top: 4px;
        color: #333;
      }
      .workspace {
        height: 85vh;
        position: relative;
        background: #fff;
        overflow: hidden;
        flex: 1;
      }
      .pot {
        position: absolute;
        bottom: 10%;
        left: 50%;
        transform: translateX(-50%);
        z-index: 0;
        width: 300px;
        pointer-events: none;
        filter: drop-shadow(0 4px 12px #0002);
      }
      .draggable-plant {
        position: absolute;
        width: 80px;
        height: 80px;
        touch-action: none;
        user-select: none;
        z-index: 1;
        transition: box-shadow 0.2s;
        transform-origin: center center;
      }
      .draggable-plant.selected {
        box-shadow: 0 0 0 3px #4caf50;
      }

      /* æŒ‰é’®æ ·å¼ */
      .fixed-btn-bar {
        position: absolute;
        display: flex;
        gap: 10px;
        z-index: 100;
        pointer-events: auto;
        background: rgba(255, 255, 255, 0.92);
        border-radius: 24px;
        box-shadow: 0 2px 8px #0001;
        align-items: center;
        border: 1.5px solid #e0ffe0;
        padding: 6px 14px;
        transition: top 0.1s, left 0.1s;
      }
      .fixed-btn-bar.top {
        /* ä¸Šæ–¹ç¼©æ”¾/æ—‹è½¬æŒ‰é’® */
        transform: translate(-50%, -100%);
      }
      .fixed-btn-bar.bottom {
        /* ä¸‹æ–¹æ“ä½œæŒ‰é’® */
        transform: translate(-50%, 10px);
      }
      .fixed-btn-bar.bottom.above {
        /* å½“ä¸‹æ–¹ç©ºé—´ä¸è¶³æ—¶ï¼Œæ˜¾ç¤ºåœ¨å›¾ç‰‡ä¸Šæ–¹ */
        transform: translate(-50%, -60px);
      }
      .fixed-btn-bar.right {
        flex-direction: column;
        transform: translate(10px, -50%);
        padding: 10px 6px;
      }
      .transform-btn,
      .action-btn,
      .layer-btn {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(145deg, #e0ffe0 60%, #b2f2c9 100%);
        color: #388e3c;
        font-size: 20px;
        font-family: inherit;
        box-shadow: 0 2px 8px #0002;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        outline: none;
        border: 1.5px solid #4caf50;
        margin: 0;
        padding: 0;
        position: relative;
      }
      .transform-btn:hover,
      .action-btn:hover,
      .layer-btn:hover,
      .transform-btn:active,
      .action-btn:active,
      .layer-btn:active {
        background: linear-gradient(145deg, #4caf50 60%, #388e3c 100%);
        color: #fff;
        border-color: #388e3c;
        box-shadow: 0 4px 12px #4caf5040;
      }
      @media (max-width: 600px) {
        .pot {
          width: 180px;
        }
        .draggable-plant {
          width: 60px;
          height: 60px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="plant-selector" id="plantSelector"></div>
      <div class="workspace" id="workspace">
        <img src="images/plant.jpg" class="pot" id="pot" draggable="false" />
      </div>
    </div>
    <script>
      // æ¤ç‰©æ•°æ®ï¼ˆä½¿ç”¨å›¾ç‰‡ï¼‰
      const plants = [
        { name: "ç«ç‘°", img: "images/plant1.jpg" },
        { name: "ä»™äººæŒ", img: "images/plant2.jpg" },
        { name: "å‘æ—¥è‘µ", img: "images/plant3.jpg" }
      ];

      // æ¸²æŸ“æ¤ç‰©é€‰æ‹©åŒº
      const plantSelector = document.getElementById("plantSelector");
      plants.forEach(plant => {
        const item = document.createElement("div");
        item.className = "plant-item";
        item.innerHTML = `<img src="${plant.img}" draggable="true" data-name="${plant.name}" data-img="${plant.img}">
                        <div class="name">${plant.name}</div>`;
        plantSelector.appendChild(item);

        // æ‹–æ‹½äº‹ä»¶
        item.querySelector("img").addEventListener("dragstart", e => {
          e.dataTransfer.setData("plant", JSON.stringify(plant));
        });

        // è§¦æ‘¸æ‹–æ‹½ï¼ˆå¹³æ¿ï¼‰
        item.querySelector("img").addEventListener("touchstart", function(e) {
          startTouchDrag(e, plant);
        });
      });

      // ä¸‹æ–¹åŒºåŸŸæ¥æ”¶æ‹–æ‹½
      const workspace = document.getElementById("workspace");
      let zIndexCounter = 1;

      workspace.addEventListener("dragover", e => e.preventDefault());
      workspace.addEventListener("drop", e => {
        e.preventDefault();
        const plant = JSON.parse(e.dataTransfer.getData("plant"));
        const x = e.clientX - workspace.getBoundingClientRect().left - 40;
        const y = e.clientY - workspace.getBoundingClientRect().top - 40;
        createDraggablePlant(plant, x, y);
      });

      // è§¦æ‘¸æ‹–æ‹½è¾…åŠ©
      let touchDragData = null;
      function startTouchDrag(e, plant) {
        touchDragData = {
          plant,
          startX: e.touches[0].clientX,
          startY: e.touches[0].clientY
        };
        document.addEventListener("touchmove", onTouchMove);
        document.addEventListener("touchend", onTouchEnd);
      }
      function onTouchMove(e) {}
      function onTouchEnd(e) {
        if (touchDragData) {
          const workspaceRect = workspace.getBoundingClientRect();
          const x = e.changedTouches[0].clientX - workspaceRect.left - 40;
          const y = e.changedTouches[0].clientY - workspaceRect.top - 40;
          if (
            e.changedTouches[0].clientX > workspaceRect.left &&
            e.changedTouches[0].clientX < workspaceRect.right &&
            e.changedTouches[0].clientY > workspaceRect.top &&
            e.changedTouches[0].clientY < workspaceRect.bottom
          ) {
            createDraggablePlant(touchDragData.plant, x, y);
          }
          touchDragData = null;
          document.removeEventListener("touchmove", onTouchMove);
          document.removeEventListener("touchend", onTouchEnd);
        }
      }

      // åˆ›å»ºå¯æ“ä½œçš„æ¤ç‰©å›¾ç‰‡
      function createDraggablePlant(plant, x, y) {
        const el = document.createElement("div");
        el.className = "draggable-plant";
        el.style.left = x + "px";
        el.style.top = y + "px";
        el.style.zIndex = ++zIndexCounter;
        el.style.width = "80px";
        el.style.height = "80px";
        el.dataset.scale = 1;
        el.dataset.rotate = 0;
        el.style.transform = "rotate(0deg) scale(1)";
        el.innerHTML = `<img src="${plant.img}" style="width:100%;height:100%;object-fit:contain;pointer-events:none;">`;
        workspace.appendChild(el);
        makePlantInteractive(el, plant);
      }

      // æ‹–æ‹½ã€é€‰ä¸­ã€æŒ‰é’®ç­‰äº¤äº’
      let selectedPlant = null;

      function makePlantInteractive(el, plantData) {
        // æ‹–æ‹½
        let offsetX,
          offsetY,
          startX,
          startY,
          dragging = false;
        el.addEventListener("mousedown", startDrag);
        el.addEventListener("touchstart", startDrag, { passive: false });

        function startDrag(e) {
          if (
            e.target.classList.contains("transform-btn") ||
            e.target.classList.contains("action-btn") ||
            e.target.classList.contains("layer-btn")
          )
            return;
          e.preventDefault();
          selectPlant(el, plantData);
          dragging = true;
          startX = e.touches ? e.touches[0].clientX : e.clientX;
          startY = e.touches ? e.touches[0].clientY : e.clientY;
          offsetX = el.offsetLeft;
          offsetY = el.offsetTop;
          document.addEventListener(
            e.type === "touchstart" ? "touchmove" : "mousemove",
            onDrag,
            { passive: false }
          );
          document.addEventListener(
            e.type === "touchstart" ? "touchend" : "mouseup",
            stopDrag
          );
        }
        function onDrag(e) {
          if (!dragging) return;
          e.preventDefault();
          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;
          el.style.left = offsetX + (clientX - startX) + "px";
          el.style.top = offsetY + (clientY - startY) + "px";
          updateButtonPositions(el);
        }
        function stopDrag(e) {
          dragging = false;
          document.removeEventListener(
            e.type === "touchend" ? "touchmove" : "mousemove",
            onDrag
          );
          document.removeEventListener(
            e.type === "touchend" ? "touchend" : "mouseup",
            stopDrag
          );
        }

        // é€‰ä¸­
        el.addEventListener("mousedown", e => {
          selectPlant(el, plantData);
          e.stopPropagation();
        });
        el.addEventListener(
          "touchstart",
          e => {
            selectPlant(el, plantData);
            e.stopPropagation();
          },
          { passive: false }
        );
      }

      // é€‰ä¸­å›¾ç‰‡ï¼Œæ˜¾ç¤ºæ“ä½œç‚¹å’ŒæŒ‰é’®
      function selectPlant(el, plantData) {
        if (selectedPlant && selectedPlant !== el) {
          selectedPlant.classList.remove("selected");
          removeActionHandles(selectedPlant);
        }
        selectedPlant = el;
        el.classList.add("selected");
        showActionHandles(el, plantData);
      }

      // æ˜¾ç¤ºæ“ä½œç‚¹å’ŒæŒ‰é’®
      function showActionHandles(el, plantData) {
        removeActionHandles(el);

        // è®¡ç®—å›¾ç‰‡ä¸­å¿ƒå’Œå››å‘¨
        const rect = el.getBoundingClientRect();
        const workspaceRect = workspace.getBoundingClientRect();
        const left = rect.left - workspaceRect.left;
        const top = rect.top - workspaceRect.top;
        const width = rect.width;
        const height = rect.height;

        // ä¸Šæ–¹ç¼©æ”¾/æ—‹è½¬æŒ‰é’®
        const transformBar = document.createElement("div");
        transformBar.className = "fixed-btn-bar top";
        workspace.appendChild(transformBar);

        // ç¼©æ”¾/æ—‹è½¬äº‹ä»¶
        transformBar.innerHTML = `
        <button class="transform-btn" title="æ”¾å¤§">ï¼‹</button>
        <button class="transform-btn" title="ç¼©å°">ï¼</button>
        <button class="transform-btn" title="å·¦æ—‹è½¬">âŸ²</button>
        <button class="transform-btn" title="å³æ—‹è½¬">âŸ³</button>
      `;
        const [
          btnZoomIn,
          btnZoomOut,
          btnRotateLeft,
          btnRotateRight
        ] = transformBar.children;
        btnZoomIn.addEventListener("pointerdown", e => {
          e.stopPropagation();
          scalePlant(el, 1.15);
          updateButtonPositions(el);
        });
        btnZoomOut.addEventListener("pointerdown", e => {
          e.stopPropagation();
          scalePlant(el, 1 / 1.15);
          updateButtonPositions(el);
        });
        btnRotateLeft.addEventListener("pointerdown", e => {
          e.stopPropagation();
          rotatePlant(el, -45);
          updateButtonPositions(el);
        });
        btnRotateRight.addEventListener("pointerdown", e => {
          e.stopPropagation();
          rotatePlant(el, 45);
          updateButtonPositions(el);
        });

        // ä¸‹æ–¹æŒ‰é’®ï¼ˆå¤åˆ¶/åˆ é™¤ï¼‰ï¼Œå¦‚æœä¸‹æ–¹ç©ºé—´ä¸è¶³åˆ™æ˜¾ç¤ºåœ¨ä¸Šæ–¹
        const actionBar = document.createElement("div");
        actionBar.className = "fixed-btn-bar bottom";
        workspace.appendChild(actionBar);
        actionBar.innerHTML = `
        <button class="action-btn" title="å¤åˆ¶">ğŸ“‹</button>
        <button class="action-btn" title="åˆ é™¤">ğŸ—‘ï¸</button>
      `;
        // å³ä¾§å±‚çº§æŒ‰é’®
        const layerBar = document.createElement("div");
        layerBar.className = "fixed-btn-bar right";
        workspace.appendChild(layerBar);
        layerBar.innerHTML = `
        <button class="layer-btn" title="ç½®é¡¶">ğŸ”</button>
        <button class="layer-btn" title="ä¸Šç§»">â¬†ï¸</button>
        <button class="layer-btn" title="ä¸‹ç§»">â¬‡ï¸</button>
      `;
        // æŒ‰é’®äº‹ä»¶
        actionBar.children[0].addEventListener("pointerdown", e => {
          e.stopPropagation();
          copyPlant(el);
        });
        actionBar.children[1].addEventListener("pointerdown", e => {
          e.stopPropagation();
          el.remove();
          removeActionHandles(el);
          selectedPlant = null;
        });
        layerBar.children[0].addEventListener("pointerdown", e => {
          e.stopPropagation();
          el.style.zIndex = ++zIndexCounter;
          updateButtonPositions(el);
        });
        layerBar.children[1].addEventListener("pointerdown", e => {
          e.stopPropagation();
          el.style.zIndex = Math.min(++el.style.zIndex, zIndexCounter);
          updateButtonPositions(el);
        });
        layerBar.children[2].addEventListener("pointerdown", e => {
          e.stopPropagation();
          el.style.zIndex = Math.max(--el.style.zIndex, 1);
          updateButtonPositions(el);
        });

        // è®°å½•æŒ‰é’®å…ƒç´ ï¼Œä¾¿äºåç»­æ›´æ–°ä½ç½®
        el._btnBars = [transformBar, actionBar, layerBar];
        updateButtonPositions(el);
      }

      function removeActionHandles(el) {
        if (!el) return;
        if (el._btnBars) {
          el._btnBars.forEach(bar => bar && bar.remove());
          el._btnBars = null;
        }
      }

      // ç¼©æ”¾
      function scalePlant(el, factor) {
        let scale = parseFloat(el.dataset.scale || 1);
        scale *= factor;
        scale = Math.max(0.3, Math.min(3, scale));
        el.dataset.scale = scale;
        updateTransform(el);
      }

      // æ—‹è½¬
      function rotatePlant(el, delta) {
        let rotate = parseFloat(el.dataset.rotate || 0);
        rotate = (rotate + delta) % 360;
        el.dataset.rotate = rotate;
        updateTransform(el);
      }

      function updateTransform(el) {
        const scale = el.dataset.scale || 1;
        const rotate = el.dataset.rotate || 0;
        el.style.transform = `rotate(${rotate}deg) scale(${scale})`;
        updateButtonPositions(el);
      }

      // æŒ‰é’®ä½ç½®æ›´æ–°
      function updateButtonPositions(el) {
        if (!el._btnBars) return;
        const [transformBar, actionBar, layerBar] = el._btnBars;
        const rect = el.getBoundingClientRect();
        const workspaceRect = workspace.getBoundingClientRect();
        const left = rect.left - workspaceRect.left;
        const top = rect.top - workspaceRect.top;
        const width = rect.width;
        const height = rect.height;

        // ä¸Šæ–¹
        transformBar.style.left = left + width / 2 + "px";
        transformBar.style.top = top + "px";

        // ä¸‹æ–¹ï¼ˆä¼˜å…ˆä¸‹æ–¹ï¼Œè‹¥ä¸‹æ–¹ç©ºé—´ä¸è¶³åˆ™ä¸Šæ–¹ï¼‰
        const actionBarHeight = 44; // 32+padding
        const spaceBelow = workspaceRect.height - (top + height);
        if (spaceBelow < actionBarHeight + 10) {
          actionBar.classList.add("above");
          actionBar.style.left = left + width / 2 + "px";
          actionBar.style.top = top + "px";
        } else {
          actionBar.classList.remove("above");
          actionBar.style.left = left + width / 2 + "px";
          actionBar.style.top = top + height + "px";
        }

        // å³ä¾§
        layerBar.style.left = left + width + "px";
        layerBar.style.top = top + height / 2 + "px";
      }

      // å¤±ç„¦ä¼˜åŒ–ï¼ˆpointerdownï¼Œä¼˜å…ˆäºclick/mousedownï¼‰
      workspace.addEventListener("pointerdown", function(e) {
        if (selectedPlant) {
          if (
            selectedPlant._btnBars &&
            selectedPlant._btnBars.some(bar => bar.contains(e.target))
          )
            return;
          if (!selectedPlant.contains(e.target)) {
            selectedPlant.classList.remove("selected");
            removeActionHandles(selectedPlant);
            selectedPlant = null;
          }
        }
      });

      // å¤åˆ¶
      function copyPlant(el) {
        const rect = el.getBoundingClientRect();
        const workspaceRect = workspace.getBoundingClientRect();
        const x = rect.left - workspaceRect.left + 30;
        const y = rect.top - workspaceRect.top + 30;
        const img = el.querySelector("img").getAttribute("src");
        const scale = el.dataset.scale || 1;
        const rotate = el.dataset.rotate || 0;
        const newEl = document.createElement("div");
        newEl.className = "draggable-plant";
        newEl.style.left = x + "px";
        newEl.style.top = y + "px";
        newEl.style.zIndex = ++zIndexCounter;
        newEl.style.width = el.style.width;
        newEl.style.height = el.style.height;
        newEl.dataset.scale = scale;
        newEl.dataset.rotate = rotate;
        newEl.style.transform = `rotate(${rotate}deg) scale(${scale})`;
        newEl.innerHTML = `<img src="${img}" style="width:100%;height:100%;object-fit:contain;pointer-events:none;">`;
        workspace.appendChild(newEl);
        makePlantInteractive(newEl, { img });
        // é€‰ä¸­æ–°å¤åˆ¶çš„å›¾ç‰‡
        setTimeout(() => selectPlant(newEl, { img }), 0);
      }

      // ä¿è¯çª—å£ç¼©æ”¾æ—¶æŒ‰é’®ä½ç½®ä¹Ÿèƒ½è·Ÿéš
      window.addEventListener("resize", function() {
        if (selectedPlant) updateButtonPositions(selectedPlant);
      });
    </script>
  </body>
</html>
