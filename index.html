<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>植物拖拽花盆（优化版）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "微软雅黑", Arial, sans-serif;
        background: #f5fff5;
        overflow: hidden;
      }
      body {
        height: 100vh;
        width: 100vw;
      }
      .container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
      }
      .plant-selector-bar {
        height: 15vh;
        min-height: 80px;
        max-height: 160px;
        background: #d0f5d0;
        display: flex;
        align-items: flex-start;
        overflow-x: auto;
        padding: 10px 0;
        box-shadow: 0 2px 8px #0001;
        z-index: 100;
      }
      .plant-item {
        flex: 0 0 auto;
        width: 80px;
        margin: 0 10px;
        text-align: center;
        cursor: grab;
        user-select: none;
      }
      .plant-item img {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        border: 2px solid #b0e0b0;
        background: #fff;
        transition: box-shadow 0.2s;
      }
      .plant-item img:active {
        box-shadow: 0 0 8px #6c6;
      }
      .plant-item span {
        display: block;
        margin-top: 4px;
        font-size: 14px;
        color: #2a4;
      }
      .main-area {
        position: relative;
        flex: 1 1 0;
        height: 85vh;
        min-height: 300px;
        width: 100vw;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f5fff5;
        overflow: hidden;
      }
      .pot-area {
        position: relative;
        width: 400px;
        height: 400px;
        min-width: 220px;
        min-height: 220px;
        max-width: 90vw;
        max-height: 90vh;
        margin: 0 auto;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        background: transparent;
        touch-action: none;
      }
      .pot-img {
        position: absolute;
        left: 50%;
        bottom: 0;
        width: 260px;
        height: 160px;
        transform: translateX(-50%);
        z-index: 0;
        pointer-events: none;
        user-select: none;
      }
      .plant-on-pot-wrapper {
        position: absolute;
        touch-action: none;
        /* for transform origin */
      }
      .plant-on-pot {
        width: 70px;
        height: 70px;
        border-radius: 12px;
        user-select: none;
        pointer-events: none;
        display: block;
        box-sizing: border-box;
        background: #fff;
        box-shadow: 0 2px 8px #0002;
        transition: box-shadow 0.2s;
      }
      .plant-on-pot.selected {
        box-shadow: 0 0 0 4px #6c6a, 0 2px 8px #0002;
        z-index: 99 !important;
      }
      .resize-handle,
      .rotate-handle {
        position: absolute;
        width: 16px;
        height: 16px;
        background: #fff;
        border: 2px solid #6c6;
        border-radius: 50%;
        box-shadow: 0 1px 4px #0002;
        z-index: 200;
        cursor: pointer;
        touch-action: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .resize-handle {
        background: #fff;
      }
      .resize-handle.nw {
        left: -10px;
        top: -10px;
        cursor: nwse-resize;
      }
      .resize-handle.ne {
        right: -10px;
        top: -10px;
        cursor: nesw-resize;
      }
      .resize-handle.sw {
        left: -10px;
        bottom: -10px;
        cursor: nesw-resize;
      }
      .resize-handle.se {
        right: -10px;
        bottom: -10px;
        cursor: nwse-resize;
      }
      .rotate-handle {
        left: 50%;
        top: -28px;
        transform: translateX(-50%);
        background: #e0ffe0;
        border: 2px solid #2a4;
        cursor: grab;
      }
      .action-buttons {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        z-index: 200;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 2px 6px;
        box-shadow: 0 2px 8px #0002;
        pointer-events: auto;
      }
      .action-buttons button,
      .layer-buttons button {
        background: #fff;
        border: 1px solid #b0e0b0;
        border-radius: 6px;
        padding: 2px 10px;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 1px 2px #0001;
        transition: background 0.2s;
      }
      .action-buttons button:hover,
      .layer-buttons button:hover {
        background: #e0ffe0;
      }
      .layer-buttons {
        position: absolute;
        display: flex;
        flex-direction: column;
        gap: 6px;
        z-index: 200;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 2px 4px;
        box-shadow: 0 2px 8px #0002;
        pointer-events: auto;
      }
      @media (max-width: 600px) {
        .pot-area {
          width: 98vw;
          height: 60vw;
          min-width: 160px;
          min-height: 120px;
        }
        .pot-img {
          width: 120px;
          height: 80px;
        }
        .plant-on-pot {
          width: 40px;
          height: 40px;
        }
        .resize-handle,
        .rotate-handle {
          width: 12px;
          height: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 植物选择区 -->
      <div class="plant-selector-bar" id="plantSelectorBar"></div>
      <!-- 花盆区域 -->
      <div class="main-area">
        <div class="pot-area" id="potArea">
          <img
            class="pot-img"
            src="https://img.icons8.com/color/96/cactus.png"
            alt="花盆"
            draggable="false"
          />
        </div>
      </div>
    </div>
    <script>
      // 植物素材
      const plants = [
        { name: "仙人掌", img: "https://img.icons8.com/color/96/cactus.png" },
        {
          name: "向日葵",
          img: "https://img.icons8.com/color/96/sunflower.png"
        },
        { name: "玫瑰", img: "https://img.icons8.com/color/96/rose.png" },
        // { name: "郁金香", img: "https://img.icons8.com/color/96/tulip.png" },
        // { name: "树苗", img: "https://img.icons8.com/color/96/seedling.png" },
        // {
        //   name: "多肉",
        //   img: "https://img.icons8.com/color/96/succulent-plant.png"
        // },
        { name: "竹子", img: "https://img.icons8.com/color/96/bamboo.png" }
      ];

      // 花盆上的植物实例
      let plantInstances = [];
      let selectedId = null;

      // 生成唯一ID
      function uuid() {
        return "xxxxxx".replace(/x/g, () =>
          ((Math.random() * 36) | 0).toString(36)
        );
      }

      // 渲染植物选择区
      const selectorBar = document.getElementById("plantSelectorBar");
      plants.forEach((p, idx) => {
        const div = document.createElement("div");
        div.className = "plant-item";
        div.draggable = true;
        div.innerHTML = `<img src="${p.img}" draggable="false"><span>${p.name}</span>`;
        div.addEventListener("dragstart", e => {
          e.dataTransfer.setData(
            "text/plain",
            JSON.stringify({ plantIdx: idx })
          );
          e.dataTransfer.effectAllowed = "copy";
        });
        selectorBar.appendChild(div);
      });

      // 花盆区域
      const potArea = document.getElementById("potArea");
      const potImg = potArea.querySelector(".pot-img");

      // 拖拽到花盆
      potArea.addEventListener("dragover", e => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "copy";
      });
      potArea.addEventListener("drop", e => {
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));
        if (typeof data.plantIdx === "number") {
          // 新植物实例
          const rect = potArea.getBoundingClientRect();
          const x = e.clientX - rect.left - 35;
          const y = e.clientY - rect.top - 35;
          plantInstances.push({
            id: uuid(),
            plantIdx: data.plantIdx,
            x,
            y,
            z: plantInstances.length + 1,
            scale: 1,
            rotate: 0
          });
          selectedId = null;
          renderPlantsOnPot();
        }
        if (data.moveId) {
          // 拖动已存在的植物
          const rect = potArea.getBoundingClientRect();
          const x = e.clientX - rect.left - 35;
          const y = e.clientY - rect.top - 35;
          const inst = plantInstances.find(p => p.id === data.moveId);
          if (inst) {
            inst.x = x;
            inst.y = y;
            renderPlantsOnPot();
          }
        }
      });

      // 渲染花盆上的植物
      function renderPlantsOnPot() {
        // 清除旧植物
        Array.from(
          potArea.querySelectorAll(
            ".plant-on-pot-wrapper, .action-buttons, .layer-buttons"
          )
        ).forEach(el => el.remove());
        // 按z排序
        plantInstances.sort((a, b) => a.z - b.z);
        plantInstances.forEach((inst, idx) => {
          // wrapper
          const wrapper = document.createElement("div");
          wrapper.className = "plant-on-pot-wrapper";
          wrapper.style.left = inst.x + "px";
          wrapper.style.top = inst.y + "px";
          wrapper.style.zIndex = inst.z;
          wrapper.style.width = "70px";
          wrapper.style.height = "70px";
          wrapper.style.transform = `scale(${inst.scale}) rotate(${inst.rotate}deg)`;
          wrapper.dataset.id = inst.id;
          wrapper.style.transformOrigin = "35px 35px";

          // 拖动
          let dragOffset = null;
          let isDragging = false;
          wrapper.addEventListener("mousedown", e => {
            if (
              e.target.classList.contains("resize-handle") ||
              e.target.classList.contains("rotate-handle")
            )
              return;
            selectedId = inst.id;
            renderPlantsOnPot();
            dragOffset = { x: e.clientX - inst.x, y: e.clientY - inst.y };
            isDragging = true;
            document.body.style.userSelect = "none";
          });
          document.addEventListener("mousemove", function moveHandler(ev) {
            if (isDragging && selectedId === inst.id) {
              inst.x = ev.clientX - dragOffset.x;
              inst.y = ev.clientY - dragOffset.y;
              wrapper.style.left = inst.x + "px";
              wrapper.style.top = inst.y + "px";
            }
          });
          document.addEventListener("mouseup", function upHandler(ev) {
            if (isDragging && selectedId === inst.id) {
              isDragging = false;
              document.body.style.userSelect = "";
              renderPlantsOnPot();
            }
          });

          // 触屏拖动
          let touchDragging = false;
          wrapper.addEventListener("touchstart", function(e) {
            if (
              e.target.classList.contains("resize-handle") ||
              e.target.classList.contains("rotate-handle")
            )
              return;
            selectedId = inst.id;
            renderPlantsOnPot();
            let touch = e.touches[0];
            let offsetX = touch.clientX - inst.x;
            let offsetY = touch.clientY - inst.y;
            touchDragging = true;
            function moveHandler(ev) {
              if (!touchDragging) return;
              let t = ev.touches[0];
              inst.x = t.clientX - offsetX;
              inst.y = t.clientY - offsetY;
              wrapper.style.left = inst.x + "px";
              wrapper.style.top = inst.y + "px";
              ev.preventDefault();
            }
            function endHandler(ev) {
              touchDragging = false;
              document.removeEventListener("touchmove", moveHandler);
              document.removeEventListener("touchend", endHandler);
              renderPlantsOnPot();
            }
            document.addEventListener("touchmove", moveHandler, {
              passive: false
            });
            document.addEventListener("touchend", endHandler);
            e.stopPropagation();
          });

          // 图片
          const el = document.createElement("img");
          el.src = plants[inst.plantIdx].img;
          el.className =
            "plant-on-pot" + (selectedId === inst.id ? " selected" : "");
          el.draggable = false;
          wrapper.appendChild(el);

          // 选中时显示按钮和控制点
          if (selectedId === inst.id) {
            // 功能按钮
            const btns = document.createElement("div");
            btns.className = "action-buttons";
            btns.innerHTML = `
            <button onclick="exportPlant('${inst.id}')">导出</button>
            <button onclick="copyPlant('${inst.id}')">复制</button>
            <button onclick="deletePlant('${inst.id}')">删除</button>
          `;
            btns.style.left = "35px";
            btns.style.top = "75px";
            btns.addEventListener("mousedown", e => e.stopPropagation());
            wrapper.appendChild(btns);

            // 层级按钮
            const lbtns = document.createElement("div");
            lbtns.className = "layer-buttons";
            lbtns.innerHTML = `
            <button onclick="toTop('${inst.id}')">置顶</button>
            <button onclick="upLayer('${inst.id}')">↑</button>
            <button onclick="downLayer('${inst.id}')">↓</button>
          `;
            lbtns.style.left = "75px";
            lbtns.style.top = "20px";
            lbtns.addEventListener("mousedown", e => e.stopPropagation());
            wrapper.appendChild(lbtns);

            // 旋转点
            const rotate = document.createElement("div");
            rotate.className = "rotate-handle";
            rotate.title = "旋转";
            let startAngle = 0,
              startRotate = 0;
            let rotating = false;
            rotate.addEventListener("mousedown", function(e) {
              e.stopPropagation();
              const rect = wrapper.getBoundingClientRect();
              const cx = rect.left + rect.width / 2;
              const cy = rect.top + rect.height / 2;
              startRotate = inst.rotate;
              startAngle =
                (Math.atan2(e.clientY - cy, e.clientX - cx) * 180) / Math.PI;
              rotating = true;
            });
            document.addEventListener("mousemove", function(ev) {
              if (rotating && selectedId === inst.id) {
                const rect = wrapper.getBoundingClientRect();
                const cx = rect.left + rect.width / 2;
                const cy = rect.top + rect.height / 2;
                const angle =
                  (Math.atan2(ev.clientY - cy, ev.clientX - cx) * 180) /
                  Math.PI;
                inst.rotate = startRotate + angle - startAngle;
                wrapper.style.transform = `scale(${inst.scale}) rotate(${inst.rotate}deg)`;
              }
            });
            document.addEventListener("mouseup", function(ev) {
              if (rotating && selectedId === inst.id) {
                rotating = false;
                renderPlantsOnPot();
              }
            });
            // 触屏旋转
            let touchRotating = false;
            rotate.addEventListener("touchstart", function(e) {
              e.stopPropagation();
              const rect = wrapper.getBoundingClientRect();
              const cx = rect.left + rect.width / 2;
              const cy = rect.top + rect.height / 2;
              startRotate = inst.rotate;
              let t = e.touches[0];
              startAngle =
                (Math.atan2(t.clientY - cy, t.clientX - cx) * 180) / Math.PI;
              touchRotating = true;
              function moveHandler(ev) {
                if (!touchRotating) return;
                let t2 = ev.touches[0];
                const angle =
                  (Math.atan2(t2.clientY - cy, t2.clientX - cx) * 180) /
                  Math.PI;
                inst.rotate = startRotate + angle - startAngle;
                wrapper.style.transform = `scale(${inst.scale}) rotate(${inst.rotate}deg)`;
                ev.preventDefault();
              }
              function endHandler(ev) {
                touchRotating = false;
                document.removeEventListener("touchmove", moveHandler);
                document.removeEventListener("touchend", endHandler);
                renderPlantsOnPot();
              }
              document.addEventListener("touchmove", moveHandler, {
                passive: false
              });
              document.addEventListener("touchend", endHandler);
            });
            wrapper.appendChild(rotate);

            // 缩放点
            const handles = [
              { cls: "nw", dx: -1, dy: -1 },
              { cls: "ne", dx: 1, dy: -1 },
              { cls: "sw", dx: -1, dy: 1 },
              { cls: "se", dx: 1, dy: 1 }
            ];
            handles.forEach(h => {
              const handle = document.createElement("div");
              handle.className = "resize-handle " + h.cls;
              handle.title = "缩放";
              let startScale = 1,
                startX = 0,
                startY = 0;
              let resizing = false;
              handle.addEventListener("mousedown", function(e) {
                e.stopPropagation();
                startScale = inst.scale;
                startX = e.clientX;
                startY = e.clientY;
                resizing = true;
              });
              document.addEventListener("mousemove", function(ev) {
                if (resizing && selectedId === inst.id) {
                  let dx = (ev.clientX - startX) * h.dx;
                  let dy = (ev.clientY - startY) * h.dy;
                  let delta = Math.max(dx, dy);
                  let newScale = Math.max(0.2, startScale + delta / 100);
                  inst.scale = newScale;
                  wrapper.style.transform = `scale(${inst.scale}) rotate(${inst.rotate}deg)`;
                }
              });
              document.addEventListener("mouseup", function(ev) {
                if (resizing && selectedId === inst.id) {
                  resizing = false;
                  renderPlantsOnPot();
                }
              });
              // 触屏缩放
              let touchResizing = false;
              handle.addEventListener("touchstart", function(e) {
                e.stopPropagation();
                startScale = inst.scale;
                let t = e.touches[0];
                startX = t.clientX;
                startY = t.clientY;
                touchResizing = true;
                function moveHandler(ev) {
                  if (!touchResizing) return;
                  let t2 = ev.touches[0];
                  let dx = (t2.clientX - startX) * h.dx;
                  let dy = (t2.clientY - startY) * h.dy;
                  let delta = Math.max(dx, dy);
                  let newScale = Math.max(0.2, startScale + delta / 100);
                  inst.scale = newScale;
                  wrapper.style.transform = `scale(${inst.scale}) rotate(${inst.rotate}deg)`;
                  ev.preventDefault();
                }
                function endHandler(ev) {
                  touchResizing = false;
                  document.removeEventListener("touchmove", moveHandler);
                  document.removeEventListener("touchend", endHandler);
                  renderPlantsOnPot();
                }
                document.addEventListener("touchmove", moveHandler, {
                  passive: false
                });
                document.addEventListener("touchend", endHandler);
              });
              wrapper.appendChild(handle);
            });
          }
          potArea.appendChild(wrapper);
        });
      }

      // 取消选中
      document.body.addEventListener("mousedown", e => {
        if (!e.target.closest(".plant-on-pot-wrapper")) {
          selectedId = null;
          renderPlantsOnPot();
        }
      });

      // 功能按钮实现
      window.deletePlant = function(id) {
        plantInstances = plantInstances.filter(p => p.id !== id);
        selectedId = null;
        renderPlantsOnPot();
      };
      window.copyPlant = function(id) {
        const inst = plantInstances.find(p => p.id === id);
        if (inst) {
          plantInstances.push({
            ...inst,
            id: uuid(),
            x: inst.x + 20,
            y: inst.y + 20,
            z: plantInstances.length + 1
          });
          renderPlantsOnPot();
        }
      };
      window.exportPlant = function(id) {
        const inst = plantInstances.find(p => p.id === id);
        if (inst) {
          const link = document.createElement("a");
          link.href = plants[inst.plantIdx].img;
          link.download = plants[inst.plantIdx].name + ".png";
          link.click();
        }
      };
      window.toTop = function(id) {
        const maxZ = Math.max(...plantInstances.map(p => p.z));
        const inst = plantInstances.find(p => p.id === id);
        if (inst) {
          inst.z = maxZ + 1;
          renderPlantsOnPot();
        }
      };
      window.upLayer = function(id) {
        const inst = plantInstances.find(p => p.id === id);
        if (inst) {
          const above = plantInstances
            .filter(p => p.z > inst.z)
            .sort((a, b) => a.z - b.z)[0];
          if (above) {
            [inst.z, above.z] = [above.z, inst.z];
            renderPlantsOnPot();
          }
        }
      };
      window.downLayer = function(id) {
        const inst = plantInstances.find(p => p.id === id);
        if (inst) {
          // 花盆z=0，不能再低
          const below = plantInstances
            .filter(p => p.z < inst.z)
            .sort((a, b) => b.z - a.z)[0];
          if (below && below.z > 0) {
            [inst.z, below.z] = [below.z, inst.z];
            renderPlantsOnPot();
          }
        }
      };

      // 初始化
      renderPlantsOnPot();
    </script>
  </body>
</html>
``` --- **优化点说明：** - 拖动、缩放、旋转时，wrapper 直接操作 style，不立即
render，操作结束后再 render，避免按钮和控制点丢失。 - 事件监听在 document
上，保证鼠标/触摸离开图片也能结束操作。 -
选中图片时，只有该图片有按钮和控制点，且始终跟随图片。 - PC 和触屏都流畅支持。
如需进一步美化或功能扩展，欢迎继续提问！
