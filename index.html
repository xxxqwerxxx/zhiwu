<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Ê§çÁâ©ÊãñÊãΩËä±ÁõÜ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        background: #f8fff8;
      }
      .container {
        height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .plant-selector {
        height: 15vh;
        min-height: 90px;
        background: #e0ffe0;
        overflow-x: auto;
        display: flex;
        align-items: center;
        padding: 10px;
        box-sizing: border-box;
      }
      .plant-item {
        margin-right: 20px;
        text-align: center;
        user-select: none;
      }
      .plant-item img {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border-radius: 8px;
        cursor: grab;
        background: #fff;
        box-shadow: 0 2px 6px #0001;
        display: block;
        margin: 0 auto;
      }
      .plant-item .name {
        font-size: 14px;
        margin-top: 4px;
        color: #333;
      }
      .workspace {
        height: 85vh;
        position: relative;
        background: #fff;
        overflow: hidden;
        flex: 1;
      }
      .pot {
        position: absolute;
        bottom: 10%;
        left: 50%;
        transform: translateX(-50%);
        z-index: 0;
        width: 300px;
        pointer-events: none;
        filter: drop-shadow(0 4px 12px #0002);
      }
      .draggable-plant {
        position: absolute;
        width: 80px;
        height: 80px;
        touch-action: none;
        user-select: none;
        z-index: 1;
        transition: box-shadow 0.2s;
        transform-origin: center center;
      }
      .draggable-plant.selected {
        box-shadow: 0 0 0 3px #4caf50;
      }
      .action-buttons {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
        bottom: -40px;
        z-index: 10;
      }
      .layer-buttons {
        position: absolute;
        right: -40px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 10;
      }
      .action-btn,
      .layer-btn {
        background: #fff;
        border: 1px solid #4caf50;
        color: #4caf50;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 1px 4px #0002;
        transition: background 0.2s, color 0.2s;
        outline: none;
      }
      .action-btn:hover,
      .layer-btn:hover,
      .action-btn:active,
      .layer-btn:active {
        background: #4caf50;
        color: #fff;
      }
      .resize-handle,
      .rotate-handle {
        position: absolute;
        width: 16px;
        height: 16px;
        background: #fff;
        border: 2px solid #4caf50;
        border-radius: 50%;
        z-index: 20;
        cursor: pointer;
        box-shadow: 0 1px 4px #0002;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .resize-handle {
        background: #fff;
      }
      .rotate-handle {
        top: -28px;
        left: 50%;
        transform: translateX(-50%);
        background: #4caf50;
        border: 2px solid #fff;
        color: #fff;
        font-size: 14px;
        cursor: grab;
      }
      .resize-tl {
        top: -8px;
        left: -8px;
        cursor: nwse-resize;
      }
      .resize-tr {
        top: -8px;
        right: -8px;
        cursor: nesw-resize;
      }
      .resize-bl {
        bottom: -8px;
        left: -8px;
        cursor: nesw-resize;
      }
      .resize-br {
        bottom: -8px;
        right: -8px;
        cursor: nwse-resize;
      }
      @media (max-width: 600px) {
        .pot {
          width: 180px;
        }
        .draggable-plant {
          width: 60px;
          height: 60px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="plant-selector" id="plantSelector"></div>
      <div class="workspace" id="workspace">
        <img src="images/plant.jpg" class="pot" id="pot" draggable="false" />
      </div>
    </div>
    <script>
      // Ê§çÁâ©Êï∞ÊçÆÔºà‰ΩøÁî®ÂõæÁâáÔºâ
      const plants = [
        { name: "Áé´Áë∞", img: "images/plant1.jpg" },
        { name: "‰ªô‰∫∫Êéå", img: "images/plant2.jpg" },
        { name: "ÂêëÊó•Ëëµ", img: "images/plant3.jpg" }
      ];

      // Ê∏≤ÊüìÊ§çÁâ©ÈÄâÊã©Âå∫
      const plantSelector = document.getElementById("plantSelector");
      plants.forEach(plant => {
        const item = document.createElement("div");
        item.className = "plant-item";
        item.innerHTML = `<img src="${plant.img}" draggable="true" data-name="${plant.name}" data-img="${plant.img}">
                        <div class="name">${plant.name}</div>`;
        plantSelector.appendChild(item);

        // ÊãñÊãΩ‰∫ã‰ª∂
        item.querySelector("img").addEventListener("dragstart", e => {
          e.dataTransfer.setData("plant", JSON.stringify(plant));
        });

        // Ëß¶Êë∏ÊãñÊãΩÔºàÂπ≥ÊùøÔºâ
        item.querySelector("img").addEventListener("touchstart", function(e) {
          startTouchDrag(e, plant);
        });
      });

      // ‰∏ãÊñπÂå∫ÂüüÊé•Êî∂ÊãñÊãΩ
      const workspace = document.getElementById("workspace");
      let zIndexCounter = 1;

      workspace.addEventListener("dragover", e => e.preventDefault());
      workspace.addEventListener("drop", e => {
        e.preventDefault();
        const plant = JSON.parse(e.dataTransfer.getData("plant"));
        const x = e.clientX - workspace.getBoundingClientRect().left - 40;
        const y = e.clientY - workspace.getBoundingClientRect().top - 40;
        createDraggablePlant(plant, x, y);
      });

      // Ëß¶Êë∏ÊãñÊãΩËæÖÂä©
      let touchDragData = null;
      function startTouchDrag(e, plant) {
        touchDragData = {
          plant,
          startX: e.touches[0].clientX,
          startY: e.touches[0].clientY
        };
        document.addEventListener("touchmove", onTouchMove);
        document.addEventListener("touchend", onTouchEnd);
      }
      function onTouchMove(e) {}
      function onTouchEnd(e) {
        if (touchDragData) {
          const workspaceRect = workspace.getBoundingClientRect();
          const x = e.changedTouches[0].clientX - workspaceRect.left - 40;
          const y = e.changedTouches[0].clientY - workspaceRect.top - 40;
          if (
            e.changedTouches[0].clientX > workspaceRect.left &&
            e.changedTouches[0].clientX < workspaceRect.right &&
            e.changedTouches[0].clientY > workspaceRect.top &&
            e.changedTouches[0].clientY < workspaceRect.bottom
          ) {
            createDraggablePlant(touchDragData.plant, x, y);
          }
          touchDragData = null;
          document.removeEventListener("touchmove", onTouchMove);
          document.removeEventListener("touchend", onTouchEnd);
        }
      }

      // ÂàõÂª∫ÂèØÊìç‰ΩúÁöÑÊ§çÁâ©ÂõæÁâá
      function createDraggablePlant(plant, x, y) {
        const el = document.createElement("div");
        el.className = "draggable-plant";
        el.style.left = x + "px";
        el.style.top = y + "px";
        el.style.zIndex = ++zIndexCounter;
        el.style.width = "80px";
        el.style.height = "80px";
        el.style.transform = "rotate(0deg)";
        el.innerHTML = `<img src="${plant.img}" style="width:100%;height:100%;object-fit:contain;pointer-events:none;">`;
        workspace.appendChild(el);
        makePlantInteractive(el, plant);
      }

      // ÊãñÊãΩ„ÄÅÁº©Êîæ„ÄÅÊóãËΩ¨„ÄÅÈÄâ‰∏≠„ÄÅÊåâÈíÆÁ≠â‰∫§‰∫í
      let selectedPlant = null;

      function makePlantInteractive(el, plantData) {
        // ÊãñÊãΩ
        let offsetX,
          offsetY,
          startX,
          startY,
          dragging = false;
        el.addEventListener("mousedown", startDrag);
        el.addEventListener("touchstart", startDrag, { passive: false });

        function startDrag(e) {
          if (
            e.target.classList.contains("resize-handle") ||
            e.target.classList.contains("rotate-handle")
          )
            return;
          e.preventDefault();
          selectPlant(el, plantData);
          dragging = true;
          startX = e.touches ? e.touches[0].clientX : e.clientX;
          startY = e.touches ? e.touches[0].clientY : e.clientY;
          offsetX = el.offsetLeft;
          offsetY = el.offsetTop;
          document.addEventListener(
            e.type === "touchstart" ? "touchmove" : "mousemove",
            onDrag,
            { passive: false }
          );
          document.addEventListener(
            e.type === "touchstart" ? "touchend" : "mouseup",
            stopDrag
          );
        }
        function onDrag(e) {
          if (!dragging) return;
          e.preventDefault();
          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;
          el.style.left = offsetX + (clientX - startX) + "px";
          el.style.top = offsetY + (clientY - startY) + "px";
        }
        function stopDrag(e) {
          dragging = false;
          document.removeEventListener(
            e.type === "touchend" ? "touchmove" : "mousemove",
            onDrag
          );
          document.removeEventListener(
            e.type === "touchend" ? "touchend" : "mouseup",
            stopDrag
          );
        }

        // ÈÄâ‰∏≠
        el.addEventListener("mousedown", e => {
          selectPlant(el, plantData);
          e.stopPropagation();
        });
        el.addEventListener(
          "touchstart",
          e => {
            selectPlant(el, plantData);
            e.stopPropagation();
          },
          { passive: false }
        );
      }

      // ÈÄâ‰∏≠ÂõæÁâáÔºåÊòæÁ§∫Êìç‰ΩúÁÇπÂíåÊåâÈíÆ
      function selectPlant(el, plantData) {
        if (selectedPlant && selectedPlant !== el) {
          selectedPlant.classList.remove("selected");
          removeActionHandles(selectedPlant);
        }
        selectedPlant = el;
        el.classList.add("selected");
        showActionHandles(el, plantData);
      }

      // ÊòæÁ§∫Êìç‰ΩúÁÇπÂíåÊåâÈíÆ
      function showActionHandles(el, plantData) {
        removeActionHandles(el);

        // Áº©ÊîæÁÇπ
        ["tl", "tr", "bl", "br"].forEach(pos => {
          const handle = document.createElement("div");
          handle.className = "resize-handle resize-" + pos;
          handle.addEventListener("mousedown", e => startResize(e, pos, el));
          handle.addEventListener("touchstart", e => startResize(e, pos, el), {
            passive: false
          });
          el.appendChild(handle);
        });

        // ÊóãËΩ¨ÁÇπ
        const rotateHandle = document.createElement("div");
        rotateHandle.className = "rotate-handle";
        rotateHandle.textContent = "‚ü≥";
        rotateHandle.addEventListener("mousedown", e => startRotate(e, el));
        rotateHandle.addEventListener("touchstart", e => startRotate(e, el), {
          passive: false
        });
        el.appendChild(rotateHandle);

        // ‰∏ãÊñπÊåâÈíÆÔºàÂ∑≤ÁßªÈô§ÂØºÂá∫ÊåâÈíÆÔºâ
        const actionBar = document.createElement("div");
        actionBar.className = "action-buttons";
        actionBar.innerHTML = `
        <button class="action-btn" title="Â§çÂà∂">üìã</button>
        <button class="action-btn" title="Âà†Èô§">üóëÔ∏è</button>
      `;
        el.appendChild(actionBar);

        // Âè≥‰æßÂ±ÇÁ∫ßÊåâÈíÆ
        const layerBar = document.createElement("div");
        layerBar.className = "layer-buttons";
        layerBar.innerHTML = `
        <button class="layer-btn" title="ÁΩÆÈ°∂">üîù</button>
        <button class="layer-btn" title="‰∏äÁßª">‚¨ÜÔ∏è</button>
        <button class="layer-btn" title="‰∏ãÁßª">‚¨áÔ∏è</button>
      `;
        el.appendChild(layerBar);

        // ÊåâÈíÆ‰∫ã‰ª∂Ôºàpointerdown‰ºòÂÖàÔºåÈò≤Ê≠¢Â§±ÁÑ¶Ôºâ
        actionBar.children[0].addEventListener("pointerdown", e => {
          e.stopPropagation();
          console.log("ÁÇπÂáª‰∫ÜÂ§çÂà∂ÊåâÈíÆ");
          copyPlant(el);
        });
        actionBar.children[1].addEventListener("pointerdown", e => {
          e.stopPropagation();
          console.log("ÁÇπÂáª‰∫ÜÂà†Èô§ÊåâÈíÆ");
          el.remove();
          removeActionHandles(el);
          selectedPlant = null;
        });
        layerBar.children[0].addEventListener("pointerdown", e => {
          e.stopPropagation();
          console.log("ÁÇπÂáª‰∫ÜÁΩÆÈ°∂ÊåâÈíÆ");
          el.style.zIndex = ++zIndexCounter;
        });
        layerBar.children[1].addEventListener("pointerdown", e => {
          e.stopPropagation();
          console.log("ÁÇπÂáª‰∫Ü‰∏äÁßªÊåâÈíÆ");
          el.style.zIndex = Math.min(++el.style.zIndex, zIndexCounter);
        });
        layerBar.children[2].addEventListener("pointerdown", e => {
          e.stopPropagation();
          console.log("ÁÇπÂáª‰∫Ü‰∏ãÁßªÊåâÈíÆ");
          el.style.zIndex = Math.max(--el.style.zIndex, 1);
        });
      }

      function removeActionHandles(el) {
        if (!el) return;
        Array.from(
          el.querySelectorAll(
            ".resize-handle, .rotate-handle, .action-buttons, .layer-buttons"
          )
        ).forEach(e => e.remove());
      }

      // Áº©Êîæ
      function startResize(e, pos, el) {
        e.preventDefault();
        e.stopPropagation();
        selectPlant(el);
        let startW = el.offsetWidth,
          startH = el.offsetHeight;
        let startL = el.offsetLeft,
          startT = el.offsetTop;
        let startX = e.touches ? e.touches[0].clientX : e.clientX;
        let startY = e.touches ? e.touches[0].clientY : e.clientY;
        function onResize(ev) {
          const clientX = ev.touches ? ev.touches[0].clientX : ev.clientX;
          const clientY = ev.touches ? ev.touches[0].clientY : ev.clientY;
          let dx = clientX - startX,
            dy = clientY - startY;
          let newW = startW,
            newH = startH,
            newL = startL,
            newT = startT;
          if (pos.includes("r")) newW = Math.max(40, startW + dx);
          if (pos.includes("l")) {
            newW = Math.max(40, startW - dx);
            newL = startL + dx;
          }
          if (pos.includes("b")) newH = Math.max(40, startH + dy);
          if (pos.includes("t")) {
            newH = Math.max(40, startH - dy);
            newT = startT + dy;
          }
          el.style.width = newW + "px";
          el.style.height = newH + "px";
          el.style.left = newL + "px";
          el.style.top = newT + "px";
        }
        function stopResize(ev) {
          document.removeEventListener(
            ev.type === "touchend" ? "touchmove" : "mousemove",
            onResize
          );
          document.removeEventListener(
            ev.type === "touchend" ? "touchend" : "mouseup",
            stopResize
          );
        }
        document.addEventListener(
          e.type === "touchstart" ? "touchmove" : "mousemove",
          onResize,
          { passive: false }
        );
        document.addEventListener(
          e.type === "touchstart" ? "touchend" : "mouseup",
          stopResize
        );
      }

      // ÊóãËΩ¨
      function startRotate(e, el) {
        e.preventDefault();
        e.stopPropagation();
        selectPlant(el);
        let rect = el.getBoundingClientRect();
        let centerX = rect.left + rect.width / 2;
        let centerY = rect.top + rect.height / 2;
        let startAngle = getRotation(el);
        function getAngle(clientX, clientY) {
          return (
            (Math.atan2(clientY - centerY, clientX - centerX) * 180) / Math.PI
          );
        }
        let startClientX = e.touches ? e.touches[0].clientX : e.clientX;
        let startClientY = e.touches ? e.touches[0].clientY : e.clientY;
        let baseAngle = getAngle(startClientX, startClientY) - startAngle;
        function onRotate(ev) {
          const clientX = ev.touches ? ev.touches[0].clientX : ev.clientX;
          const clientY = ev.touches ? ev.touches[0].clientY : ev.clientY;
          let angle = getAngle(clientX, clientY) - baseAngle;
          el.style.transform = `rotate(${angle}deg)`;
        }
        function stopRotate(ev) {
          document.removeEventListener(
            ev.type === "touchend" ? "touchmove" : "mousemove",
            onRotate
          );
          document.removeEventListener(
            ev.type === "touchend" ? "touchend" : "mouseup",
            stopRotate
          );
        }
        document.addEventListener(
          e.type === "touchstart" ? "touchmove" : "mousemove",
          onRotate,
          { passive: false }
        );
        document.addEventListener(
          e.type === "touchstart" ? "touchend" : "mouseup",
          stopRotate
        );
      }
      function getRotation(el) {
        const st = window.getComputedStyle(el, null);
        const tr = st.getPropertyValue("transform");
        if (tr === "none") return 0;
        const values = tr
          .split("(")[1]
          .split(")")[0]
          .split(",");
        const a = values[0],
          b = values[1];
        return Math.round(Math.atan2(b, a) * (180 / Math.PI));
      }

      // Â§±ÁÑ¶‰ºòÂåñÔºàpointerdownÔºå‰ºòÂÖà‰∫éclick/mousedownÔºâ
      workspace.addEventListener("pointerdown", function(e) {
        // Âè™Âú®ÁÇπÂáªÁ©∫ÁôΩÂ§ÑÊàñÈùûÈÄâ‰∏≠ÂÖÉÁ¥†Êó∂Â§±ÁÑ¶
        if (selectedPlant && !selectedPlant.contains(e.target)) {
          selectedPlant.classList.remove("selected");
          removeActionHandles(selectedPlant);
          selectedPlant = null;
        }
      });

      // Â§çÂà∂
      function copyPlant(el) {
        const rect = el.getBoundingClientRect();
        const workspaceRect = workspace.getBoundingClientRect();
        const x = rect.left - workspaceRect.left + 30;
        const y = rect.top - workspaceRect.top + 30;
        const img = el.querySelector("img").getAttribute("src");
        createDraggablePlant({ img }, x, y);
      }
    </script>
  </body>
</html>
